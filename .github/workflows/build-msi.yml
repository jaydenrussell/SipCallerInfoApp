
name: Build MSI Installer (WinUI 3, WiX v3)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:


jobs:
  build-msi:
    runs-on: windows-latest
    env:
      UPGRADE_CODE: "{E3A1C4F5-1234-4B7D-9D2B-ABCD12345678}"
      PUBLISH_OUT: "${{ github.workspace }}\\publish-win-x64"
      INSTALLER_DIR: "${{ github.workspace }}\\SipCallerInfoApp\\installer"
      MSI_OUTPUT: "${{ github.workspace }}\\SipCallerInfoApp\\installer\\SipCallerInfoApp.msi"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: List workspace (debug)
        shell: pwsh
        run: |
          Write-Host "Workspace: $env:GITHUB_WORKSPACE"
          Get-ChildItem -Path $env:GITHUB_WORKSPACE -Recurse -File | Select-Object -First 80 | Format-Table FullName

      # ... Restore/Publish steps (with correct DefineConstants handling) ...

      

      - name: List installer dir (debug)
        shell: pwsh
        run: |         
          Write-Host "Workspace: $env:GITHUB_WORKSPACE"
            if (Test-Path "$env:INSTALLER_DIR") {
              Write-Host "Installer dir contents:"
              Get-ChildItem "$env:INSTALLER_DIR" -Recurse | Format-Table FullName
            } else {
              Write-Host "Installer dir does not exist: $env:INSTALLER_DIR"
              Write-Host "Top-level directories in workspace:"
              Get-ChildItem $env:GITHUB_WORKSPACE -Directory | Format-Table FullName
            }

  
      - name: Verify WiX authoring exists
        shell: pwsh
        run: |
          $wxs = Join-Path $env:INSTALLER_DIR "SipCallerInfoApp.wxs"
          if (-not (Test-Path $wxs)) {
            Write-Error "Missing $wxs. Ensure the file is committed or enable the optional generation step."
          } else {
            Write-Host "Found WiX authoring: $wxs"
          }

      # (Optional) generate minimal WXS if missing â€” insert here if you want resiliency

      - name: Harvest publish folder with Heat
        shell: pwsh
        run: |
          & "$env:WIXBIN\heat.exe" dir "$env:PUBLISH_OUT" `
            -cg SipCallerInfoAppComponents `
            -dr INSTALLFOLDER `
            -var var.PublishDir `
            -sfrag -srd -suid -sreg `
            -o "$env:INSTALLER_DIR\SipCallerInfoApp.Components.wxs"

      - name: Compile (candle)
        shell: pwsh
        run: |
          & "$env:WIXBIN\candle.exe" `
            -d PublishDir="$env:PUBLISH_OUT" `
            -d UpgradeCode="$env:UPGRADE_CODE" `
            "$env:INSTALLER_DIR\SipCallerInfoApp.wxs" `
            "$env:INSTALLER_DIR\SipCallerInfoApp.Components.wxs"

      - name: Link (light)
        shell: pwsh
        run: |
          & "$env:WIXBIN\light.exe" `
            -ext WixUIExtension `
            -cultures:en-us `
            -out "$env:MSI_OUTPUT" `
            "$env:INSTALLER_DIR\SipCallerInfoApp.wixobj" `
            "$env:INSTALLER_DIR\SipCallerInfoApp.Components.wixobj"

      - name: Upload MSI artifact
        uses: actions/upload-artifact@v4
        with:
          name: SipCallerInfoApp-MSI
          path: ${{ env.MSI_OUTPUT }}
          if-no-files-found: error

