name: Build MSI (WiX v3)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-msi:
    runs-on: windows-latest

    env:
      # Choose a permanent UpgradeCode GUID (do not change across releases).
      UPGRADE_CODE: "{E3A1C4F5-1234-4B7D-9D2B-ABCD12345678}"
      # Adjust the publish path if your solution layout differs.
      PUBLISH_DIR: D:\a\SipCallerInfoApp\SipCallerInfoApp\src\SipCallerInfoApp\bin\Release\net8.0-windows10.0.19041.0\win-x64\publish
      SOLUTION_PATH: .\SipCallerInfoApp\SipCallerInfoApp.sln
      CSPROJ_PATH: .\SipCallerInfoApp\src\SipCallerInfoApp\SipCallerInfoApp.csproj
      INSTALLER_DIR: D:\a\SipCallerInfoApp\SipCallerInfoApp\installer
      MSI_OUTPUT: D:\a\SipCallerInfoApp\SipCallerInfoApp\installer\SipCallerInfoApp.msi

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Restore & Publish (self-contained)
        shell: pwsh
        run: |
          dotnet restore $env:SOLUTION_PATH
          dotnet publish $env:CSPROJ_PATH `
            -c Release `
            -r win-x64 `
            --self-contained true `
            -p:PublishSingleFile=false `
            -p:IncludeNativeLibrariesForSelfExtract=false

      - name: Install WiX Toolset v3
        uses: microsoft/setup-wix@v1
        with:
          wix-version: "3.14.1.8722"

      - name: Harvest publish folder with Heat
        shell: pwsh
        run: |
          heat.exe dir "$env:PUBLISH_DIR" `
            -cg SipCallerInfoAppComponents `
            -dr INSTALLFOLDER `
            -var var.PublishDir `
            -sfrag -srd -suid -sreg `
            -o "$env:INSTALLER_DIR\SipCallerInfoApp.Components.wxs"

      - name: Validate UpgradeCode placeholder not present
        shell: pwsh
        run: |
          $wxs = Get-Content "$env:INSTALLER_DIR\SipCallerInfoApp.wxs" -Raw
          if ($wxs -match 'UpgradeCode="PUT-GUID-HERE"') {
            Write-Error "UpgradeCode placeholder detected in SipCallerInfoApp.wxs. Replace with a permanent GUID or use Candle -d UpgradeCode."
          }

      - name: Compile (candle)
        shell: pwsh
        run: |
          candle.exe `
            -d PublishDir="$env:PUBLISH_DIR" `
            -d UpgradeCode="$env:UPGRADE_CODE" `
            "$env:INSTALLER_DIR\SipCallerInfoApp.wxs" `
            "$env:INSTALLER_DIR\SipCallerInfoApp.Components.wxs"

      - name: Link (light)
        shell: pwsh
        run: |
          light.exe `
            -ext WixUIExtension `
            -cultures:en-us `
            -out "$env:MSI_OUTPUT" `
            "$env:INSTALLER_DIR\SipCallerInfoApp.wixobj" `
            "$env:INSTALLER_DIR\SipCallerInfoApp.Components.wixobj"

      - name: Upload MSI artifact
        uses: actions/upload-artifact@v4
        with:
          name: SipCallerInfoApp-MSI
          path: ${{ env.MSI_OUTPUT }}
          if-no-files-found: error
